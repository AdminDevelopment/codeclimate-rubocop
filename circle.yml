machine:
  services:
    - docker

dependencies:
  override:
    - make image

test:
  override:
    - make test

deployment:
  registry:
    branch: master
    owner: codeclimate
    commands:
      - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
      - make release RELEASE_TAG=latest
      - make release RELEASE_TAG=b$CIRCLE_BUILD_NUM

      # Temporarily push to GCR
      - docker login -u _json_key -p "$(echo $GCLOUD_JSON_KEY_BASE64 | sed 's/ //g' | base64 -d)" us.gcr.io
      - make release RELEASE_REGISTRY=us.gcr.io/code_climate RELEASE_TAG=b$CIRCLE_BUILD_NUM

notify:
  webhooks:
    - url: https://cc-slack-proxy.herokuapp.com/circle
